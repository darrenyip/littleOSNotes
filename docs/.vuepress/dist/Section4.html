<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Little OS Lab | Section 4 Notes</title>
    <meta name="description" content="">
    
    
    <link rel="preload" href="/assets/css/6.styles.45ac861a.css" as="style"><link rel="preload" href="/assets/js/app.120eb4dd.js" as="script"><link rel="preload" href="/assets/js/1.88d0d0ab.js" as="script"><link rel="prefetch" href="/assets/js/0.ecb6548b.js"><link rel="prefetch" href="/assets/js/2.911b96c9.js"><link rel="prefetch" href="/assets/js/3.5c5ead23.js"><link rel="prefetch" href="/assets/js/4.dd3b45d1.js"><link rel="prefetch" href="/assets/js/5.c47540f9.js">
    <link rel="stylesheet" href="/assets/css/6.styles.45ac861a.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div><a href="/" class="home-link router-link-active"><!----><span class="site-name">
      Little OS Lab
    </span></a><div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""><!----></div><nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">Sections</a></div><div class="nav-item"><a href="/about.html" class="nav-link">About</a></div><!----></nav></div></header><div class="sidebar-mask"></div><div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">Sections</a></div><div class="nav-item"><a href="/about.html" class="nav-link">About</a></div><!----></nav><ul class="sidebar-links"><li><a href="/" class="sidebar-link">little OS book notes</a></li><li><a href="/Section1.html" class="sidebar-link">Section 1 Notes</a></li><li><a href="/Section2.html" class="sidebar-link">Section 2 Notes</a></li><li><a href="/Section3.html" class="sidebar-link">Section 3 Notes</a></li><li><a href="/Section4.html" class="active sidebar-link">Section 4 Notes</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/Section4.html#_4-1-header-files-folder" class="sidebar-link">4.1 Header files folder</a></li><li class="sidebar-sub-header"><a href="/Section4.html#_4-2-the-framebuffer" class="sidebar-link">4.2 The Framebuffer</a></li><li class="sidebar-sub-header"><a href="/Section4.html#_4-3-the-serial-ports" class="sidebar-link">4.3 The Serial Ports</a></li></ul></li></ul></div><div class="page"><div class="content"><h1 id="section-4-notes"><a href="#section-4-notes" aria-hidden="true" class="header-anchor">#</a> Section 4 Notes</h1><p>This section focused on output, how to display text on the console, and how to writing data to the file (in the original book it called <a href="https://littleosbook.github.io/#output" target="_blank" rel="noopener noreferrer">serial port<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>). In order to do this, we need to create two drivers: A driver for framebuffer and a driver for serial port. We will have separate folder to save the header files, which is a better way to manage the code.</p><h2 id="_4-1-header-files-folder"><a href="#_4-1-header-files-folder" aria-hidden="true" class="header-anchor">#</a> 4.1 Header files folder</h2><p>You do can write all your code inside <code>kmain.c</code>. But it is a good idea to separate the code into small pieces. If you don't want to do this, you can skip this part.</p><p>Create a new folder called <code>headers</code> in your root directory, you will save all your header files into this folder latter. Then add the <code>-I$(HEADERS)</code> to your <code>Makefile</code> to link all the header files. The updated <code>Makefile</code> is below:</p><div class="language-makefile extra-class"><pre class="language-makefile"><code>OBJECTS <span class="token operator">=</span> loader.o kmain.o framebuffer.o io.o serialport.o
CC <span class="token operator">=</span> gcc

CFLAGS <span class="token operator">=</span> -m32 -nostdlib -nostdinc -fno-builtin -fno-stack-protector \
             -nostartfiles -nodefaultlibs -Wall -Wextra -Werror -c -I<span class="token variable">$</span><span class="token punctuation">(</span>HEADERS<span class="token punctuation">)</span>
LDFLAGS <span class="token operator">=</span> -T link.ld -melf_i386
AS <span class="token operator">=</span> nasm
ASFLAGS <span class="token operator">=</span> -f elf
HEADERS <span class="token operator">=</span> headers

<span class="token symbol">all</span><span class="token punctuation">:</span> kernel.elf

<span class="token symbol">kernel.elf</span><span class="token punctuation">:</span> <span class="token variable">$</span><span class="token punctuation">(</span>OBJECTS<span class="token punctuation">)</span>
	<span class="token operator">@</span>ld <span class="token variable">$</span><span class="token punctuation">(</span>LDFLAGS<span class="token punctuation">)</span> <span class="token variable">$</span><span class="token punctuation">(</span>OBJECTS<span class="token punctuation">)</span> -o kernel.elf

<span class="token symbol">os.iso</span><span class="token punctuation">:</span> kernel.elf
	<span class="token operator">@</span>cp kernel.elf iso/boot/kernel.elf
	<span class="token operator">@</span>genisoimage -R                              \
                 -b boot/grub/stage2_eltorito    \
                 -no-emul-boot                   \
                 -boot-load-size 4               \
                 -A os                           \
                 -input-charset utf8             \
                 -quiet                          \
                 -boot-info-table                \
                 -o os.iso                       \
                 iso

<span class="token symbol">run</span><span class="token punctuation">:</span> os.iso
	bochs -f bochsrc.txt -q

<span class="token symbol">%.o</span><span class="token punctuation">:</span> %.c
	<span class="token variable">$</span><span class="token punctuation">(</span>CC<span class="token punctuation">)</span> <span class="token variable">$</span><span class="token punctuation">(</span>CFLAGS<span class="token punctuation">)</span>  <span class="token variable">$&lt;</span> -o <span class="token variable">$@</span>

<span class="token symbol">%.o</span><span class="token punctuation">:</span> %.s
	<span class="token operator">@</span><span class="token variable">$</span><span class="token punctuation">(</span>AS<span class="token punctuation">)</span> <span class="token variable">$</span><span class="token punctuation">(</span>ASFLAGS<span class="token punctuation">)</span> <span class="token variable">$&lt;</span> -o <span class="token variable">$@</span>

<span class="token symbol">clean</span><span class="token punctuation">:</span>
	rm -rf *.o kernel.elf os.iso
</code></pre></div><div class="tip custom-block"><p class="custom-block-title">TIP</p><p>The <code>@</code> before each command means ignore the output to the screen. You can add or remove it depends on your favor.</p></div><h2 id="_4-2-the-framebuffer"><a href="#_4-2-the-framebuffer" aria-hidden="true" class="header-anchor">#</a> 4.2 The Framebuffer</h2><p>This part will create a driver for framebuffer, it will display a character or a sentence to the console.</p><h3 id="_4-2-1-writing-text-and-controlling-the-cursor"><a href="#_4-2-1-writing-text-and-controlling-the-cursor" aria-hidden="true" class="header-anchor">#</a> 4.2.1 Writing Text and controlling the cursor</h3><p>Create a file called <code>framebuffer.c</code>.</p><div class="tip custom-block"><p class="custom-block-title">TIP</p><p>You should figured out what files we need from the <code>Makefile</code> above. üòÜ</p></div><p>The <code>framebuffer</code> made two things, display a character into the console, and display a line of words (or a sentence) into the console. Below is the code we wrote:</p><div class="language-c extra-class"><pre class="language-c"><code><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&quot;framebuffer.h&quot;</span></span>

<span class="token comment">/** fb_write_cell:
 *  Writes a character with the given foreground and background to position i
 *  in the framebuffer.
 *
 *  @param i  The location in the framebuffer
 *  @param c  The character
 *  @param fg The foreground color
 *  @param bg The background color
 */</span>
<span class="token keyword">void</span> <span class="token function">fb_write_cell</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> i<span class="token punctuation">,</span> <span class="token keyword">char</span> c<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> fg<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> bg<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>fb <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token number">0x000B8000</span><span class="token punctuation">;</span>
    fb<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> c<span class="token punctuation">;</span>
    fb<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>fg <span class="token operator">&amp;</span> <span class="token number">0x0F</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span>bg <span class="token operator">&amp;</span> <span class="token number">0x0F</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/** fb_write_string:
 *  Writes a sentence with the given foreground and background to position i
 *  in the framebuffer.
 *
 *  @param i  The location in the framebuffer
 *  @param s  The string
 *  @param fg The foreground color
 *  @param bg The background color
 */</span>
<span class="token keyword">void</span> <span class="token function">fb_write_string</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> i<span class="token punctuation">,</span> <span class="token keyword">char</span> s<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> fg<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> bg<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token keyword">char</span> key <span class="token operator">=</span> s<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">char</span> <span class="token operator">*</span>fb <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token number">0x000B8000</span><span class="token punctuation">;</span>
		fb<span class="token punctuation">[</span>i <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> key<span class="token punctuation">;</span>
		fb<span class="token punctuation">[</span>i <span class="token operator">*</span> <span class="token number">2</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>fg <span class="token operator">&amp;</span> <span class="token number">0x0F</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span>bg <span class="token operator">&amp;</span> <span class="token number">0x0F</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		i<span class="token operator">++</span><span class="token punctuation">;</span>
		<span class="token function">fb_write_string</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> s<span class="token punctuation">,</span> fg<span class="token punctuation">,</span> bg<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">/** fb_move_cursor:
 *  Moves the cursor of the framebuffer to the given position
 *  @param pos The new position of the cursor
 */</span>
<span class="token keyword">void</span> <span class="token function">fb_move_cursor</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">short</span> pos<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">outb</span><span class="token punctuation">(</span>FB_COMMAND_PORT<span class="token punctuation">,</span> FB_HIGH_BYTE_COMMAND<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">outb</span><span class="token punctuation">(</span>FB_DATA_PORT<span class="token punctuation">,</span>    <span class="token punctuation">(</span><span class="token punctuation">(</span>pos <span class="token operator">&gt;&gt;</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x00FF</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">outb</span><span class="token punctuation">(</span>FB_COMMAND_PORT<span class="token punctuation">,</span> FB_LOW_BYTE_COMMAND<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">outb</span><span class="token punctuation">(</span>FB_DATA_PORT<span class="token punctuation">,</span>    pos <span class="token operator">&amp;</span> <span class="token number">0x00FF</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/** fb_write_cursor:
 *  Writes a sentence of length followed by the cursor
 * 
 *  @param buf         The array of characters
 *  @param len         The length of the array
 *  @param cursorStart The starting position of the cursor
 *  @return            The end position of the cursor
 */</span>
<span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token function">fb_write_cursor</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>buf<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> len<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> cursorStart<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">unsigned</span> <span class="token keyword">int</span> cursorPos <span class="token operator">=</span> cursorStart<span class="token punctuation">;</span>
  <span class="token keyword">unsigned</span> <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token function">fb_move_cursor</span><span class="token punctuation">(</span>cursorPos<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span> <span class="token punctuation">;</span> i <span class="token operator">&lt;</span> len<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>buf<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">fb_write_cell</span><span class="token punctuation">(</span><span class="token punctuation">(</span>cursorPos<span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">,</span> buf<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> BG_CYAN<span class="token punctuation">,</span> FB_DARK_GREY<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">fb_move_cursor</span><span class="token punctuation">(</span>cursorPos<span class="token punctuation">)</span><span class="token punctuation">;</span>
    cursorPos<span class="token operator">++</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">fb_move_cursor</span><span class="token punctuation">(</span>cursorPos<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> cursorPos<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="tip custom-block"><p class="custom-block-title">TIP</p><p><code>fb_write_string</code> is the function we have tried to display a sentence based on <code>fb_write_cell</code> function. But you have to be careful to compute the position.</p></div><p>Inside the <code>headers</code> folder, create the first header file <code>framebuffer.h</code>, and paste code below:</p><div class="language-c extra-class"><pre class="language-c"><code><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&quot;io.h&quot;</span></span>

<span class="token comment">/* The I/O ports */</span>
<span class="token macro property">#<span class="token directive keyword">define</span> FB_COMMAND_PORT         0x3D4</span>
<span class="token macro property">#<span class="token directive keyword">define</span> FB_DATA_PORT            0x3D5</span>

<span class="token comment">/* The I/O port commands */</span>
<span class="token macro property">#<span class="token directive keyword">define</span> FB_HIGH_BYTE_COMMAND    14</span>
<span class="token macro property">#<span class="token directive keyword">define</span> FB_LOW_BYTE_COMMAND     15</span>

<span class="token comment">/* Colors */</span>
<span class="token macro property">#<span class="token directive keyword">define</span> BG_GREEN 2</span>
<span class="token macro property">#<span class="token directive keyword">define</span> FB_GREEN 2</span>
<span class="token macro property">#<span class="token directive keyword">define</span> FB_DARK_GREY 8</span>
<span class="token macro property">#<span class="token directive keyword">define</span> BG_CYAN 3</span>

<span class="token keyword">void</span> <span class="token function">fb_write_cell</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> i<span class="token punctuation">,</span> <span class="token keyword">char</span> c<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> fg<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> bg<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">fb_write_string</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> i<span class="token punctuation">,</span> <span class="token keyword">char</span> s<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> fg<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> bg<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token function">fb_write_cursor</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>buf<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> len<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> cursorStart<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><div class="tip custom-block"><p class="custom-block-title">TIP</p><p>You can find the magic number of the color in <a href="https://littleosbook.github.io/#writing-text" target="_blank" rel="noopener noreferrer">from original book<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>.</p></div><p>It's not easy to move the blinking cursor. This job could be done via two different I/O ports, one for accepting data and other one for describing the data being received. We need create a new assembly file <code>io.s</code> in the <code>root</code> directory with the &quot;outbound&quot; function, so that the assembly code can be accessed from C via the calling:</p><div class="language-assembly extra-class"><pre class="language-text"><code>global outb             ; make the label outb visible outside this file

; outb - send a byte to an I/O port
; stack: [esp + 8] the data byte
;        [esp + 4] the I/O port
;        [esp    ] return address
outb:
    mov al, [esp + 8]    ; move the data to be sent into the al register
    mov dx, [esp + 4]    ; move the address of the I/O port into the dx register
    out dx, al           ; send the data to the I/O port
    ret
</code></pre></div><p>We also need to connect this assembly code with C code, so that we can control the cursor through C code instead of assembly. Creating a header <code>io.h</code> in the <code>headers</code> folder, then paste code:</p><div class="language-c extra-class"><pre class="language-c"><code><span class="token macro property">#<span class="token directive keyword">ifndef</span> INCLUDE_IO_H</span>
<span class="token macro property">#<span class="token directive keyword">define</span> INCLUDE_IO_H</span>

<span class="token comment">/** outb:
     *  Sends the given data to the given I/O port. Defined in io.s
     *
     *  @param port The I/O port to send the data to
     *  @param data The data to send to the I/O port
     */</span>
<span class="token keyword">void</span> <span class="token function">outb</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">short</span> port<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property">#<span class="token directive keyword">endif</span> </span><span class="token comment">/* INCLUDE_IO_H */</span>
</code></pre></div><p>Now all necessary code are done. Back to <code>kmain.c</code>, try some code below:</p><div class="language-c extra-class"><pre class="language-c"><code><span class="token comment">/* IO */</span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&quot;framebuffer.h&quot;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// fb_write_cell(0, 'A', FB_GREEN, FB_DARK_GREY);</span>
    <span class="token keyword">char</span> str<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">&quot;LittleOS Loaded!&quot;</span><span class="token punctuation">;</span>
    <span class="token comment">// fb_write_string(0, str, BG_CYAN, FB_DARK_GREY);</span>
    <span class="token function">fb_write_cursor</span><span class="token punctuation">(</span>str<span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">0x01E0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>And remember to change the <code>loader.s</code> file:</p><div class="language-assembly extra-class"><pre class="language-text"><code>global loader

MAGIC_NUMBER equ 0x1BADB002
FLAGS equ 0x0
CHECKSUM equ -MAGIC_NUMBER
KERNAL_STACK_SIZE equ 4096

extern main

section .bss
align 4
kernal_stack:
    resb KERNAL_STACK_SIZE

section .text
align 4
    dd MAGIC_NUMBER
    dd FLAGS
    dd CHECKSUM

loader:
    mov esp, kernal_stack + KERNAL_STACK_SIZE
    call main
    mov eax, 0xCAFEBABE
.loop:
    jmp .loop
</code></pre></div><p>We should call <code>main</code> instead of <code>sum_of_three</code>.</p><p>Finally run your <code>Bochs</code>, see what happened, you should see some similar result as ours, depends on which function you called in <code>main</code>.</p><p>Result of <code>fb_write_cell()</code>, notice the letter <code>A</code> with the green background at the up left corner:</p><p><img src="/assets/img/4.2_writealetter.930719e0.png" alt="4.2_writealetter"></p><p>Result of <code>fb_write_string()</code>, the cursor won't follow at the end of the sentence:
<img src="/assets/img/4.2_writeasentence.ecccf9e0.png" alt="4.2_writeasentence"></p><p>Result of <code>fb_write_cursor()</code>, the cursor is followed at the end of a sentence:
<img src="/assets/img/4.2_writewithcursor.7a701f97.png" alt="4.2_writewithcursor"></p><div class="tip custom-block"><p class="custom-block-title">TIP</p><p>If you got the error said <code>make: *** No rule to make target 'serialport.o', needed by 'kernel.elf'. Stop.</code>, you can remove the <code>serialport.o</code> in the <code>Makefile</code> since we did not write it yet. You will need to add it latter.</p></div><h2 id="_4-3-the-serial-ports"><a href="#_4-3-the-serial-ports" aria-hidden="true" class="header-anchor">#</a> 4.3 The Serial Ports</h2><p>This part is a little bit hard to understand, but you can think about serial port as an interface for you to input and output. For example, you can input some text from your code and then write into a file.</p><p>We need to add few lines of assembly code to handle the writing data via data I/O port, add the <code>inb</code> assembly function to read the contents of an I/O port. So inside <code>io.s</code>:</p><div class="language-assembly extra-class"><pre class="language-text"><code>global outb             ; make the label outb visible outside this file
...

global inb

; inb - returns a byte from the given I/O port
; stack: [esp + 4] The address of the I/O port
;        [esp    ] The return address
inb:
    mov dx, [esp + 4]       ; move the address of the I/O port to the dx register
    in  al, dx              ; read a byte from the I/O port and store it in the al register
    ret                     ; return the read byte
</code></pre></div><p>In <code>headers/io.h</code> file, adding the configuration of serial port, and connecting the &quot;inbound&quot; assembly code :</p><div class="language-c extra-class"><pre class="language-c"><code><span class="token comment">/* The I/O ports */</span>

<span class="token comment">/* All the I/O ports are calculated relative to the data port. This is because
     * all serial ports (COM1, COM2, COM3, COM4) have their ports in the same
     * order, but they start at different values.
     */</span>

<span class="token macro property">#<span class="token directive keyword">define</span> SERIAL_COM1_BASE                0x3F8      </span><span class="token comment">/* COM1 base port */</span>

<span class="token macro property">#<span class="token directive keyword">define</span> SERIAL_DATA_PORT(base)          (base)</span>
<span class="token macro property">#<span class="token directive keyword">define</span> SERIAL_FIFO_COMMAND_PORT(base)  (base + 2)</span>
<span class="token macro property">#<span class="token directive keyword">define</span> SERIAL_LINE_COMMAND_PORT(base)  (base + 3)</span>
<span class="token macro property">#<span class="token directive keyword">define</span> SERIAL_MODEM_COMMAND_PORT(base) (base + 4)</span>
<span class="token macro property">#<span class="token directive keyword">define</span> SERIAL_LINE_STATUS_PORT(base)   (base + 5)</span>

<span class="token comment">/* SERIAL_LINE_ENABLE_DLAB:
     * Tells the serial port to expect first the highest 8 bits on the data port,
     * then the lowest 8 bits will follow
     */</span>
<span class="token macro property">#<span class="token directive keyword">define</span> SERIAL_LINE_ENABLE_DLAB         0x80</span>

<span class="token macro property">#<span class="token directive keyword">ifndef</span> INCLUDE_IO_H</span>
<span class="token macro property">#<span class="token directive keyword">define</span> INCLUDE_IO_H</span>

<span class="token comment">/** outb:
 *  Sends the given data to the given I/O port. Defined in io.s
 *
 *  @param port The I/O port to send the data to
 *  @param data The data to send to the I/O port
 */</span>
<span class="token keyword">void</span> <span class="token function">outb</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">short</span> port<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property">#<span class="token directive keyword">endif</span> </span><span class="token comment">/* INCLUDE_IO_H */</span>

<span class="token comment">/** inb:
 *  Read a byte from an I/O port.
 *
 *  @param  port The address of the I/O port
 *  @return      The read byte
 */</span>
<span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token function">inb</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">short</span> port<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Then create <code>serialport.c</code> in the <code>root</code> directory, paste the defined function below:</p><div class="language-c extra-class"><pre class="language-c"><code><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&quot;io.h&quot;</span></span>

<span class="token comment">/* The I/O port commands */</span>

<span class="token comment">/** serial_configure_baud_rate:
 *  Sets the speed of the data being sent. The default speed of a serial
 *  port is 115200 bits/s. The argument is a divisor of that number, hence
 *  the resulting speed becomes (115200 / divisor) bits/s.
 *
 *  @param com      The COM port to configure
 *  @param divisor  The divisor
 */</span>
<span class="token keyword">void</span> <span class="token function">serial_configure_baud_rate</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">short</span> com<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">short</span> divisor<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">outb</span><span class="token punctuation">(</span><span class="token function">SERIAL_LINE_COMMAND_PORT</span><span class="token punctuation">(</span>com<span class="token punctuation">)</span><span class="token punctuation">,</span>
            SERIAL_LINE_ENABLE_DLAB<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">outb</span><span class="token punctuation">(</span><span class="token function">SERIAL_DATA_PORT</span><span class="token punctuation">(</span>com<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">(</span>divisor <span class="token operator">&gt;&gt;</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x00FF</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">outb</span><span class="token punctuation">(</span><span class="token function">SERIAL_DATA_PORT</span><span class="token punctuation">(</span>com<span class="token punctuation">)</span><span class="token punctuation">,</span>
            divisor <span class="token operator">&amp;</span> <span class="token number">0x00FF</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/** serial_configure_line:
 *  Configures the line of the given serial port. The port is set to have a
 *  data length of 8 bits, no parity bits, one stop bit and break control
 *  disabled.
 *
 *  @param com  The serial port to configure
 */</span>
<span class="token keyword">void</span> <span class="token function">serial_configure_line</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">short</span> com<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">/* Bit:     | 7 | 6 | 5 4 3 | 2 | 1 0 |
     * Content: | d | b | prty  | s | dl  |
     * Value:   | 0 | 0 | 0 0 0 | 0 | 1 1 | = 0x03
     */</span>
    <span class="token function">outb</span><span class="token punctuation">(</span><span class="token function">SERIAL_LINE_COMMAND_PORT</span><span class="token punctuation">(</span>com<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0x03</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/** serial_configure_buffers
*   Configure the FIFOs of the given serial port. The port is set to have a
*   FIFO enabled, both transmission and reciever queues cleared, with 
*   14 byte FIFOs
*/</span>
<span class="token keyword">void</span> <span class="token function">serial_configure_buffers</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> com<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token comment">/* Bit:     | 7 6 | 5  | 4 | 3   | 2   | 1   | 0 |
	* Content:	| lvl | bs | r | dma | clt | clr | e |
	* Value:	| 1 1 | 0  | 0 |  0  |  1  |  1  | 1 | = 0xC7
	*/</span>
	<span class="token function">outb</span><span class="token punctuation">(</span><span class="token function">SERIAL_FIFO_COMMAND_PORT</span><span class="token punctuation">(</span>com<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0xC7</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/** serial_configure_modem
*   Configure the Modem of the given serial port. The port is set to have a 
*   Modem with no interrupts enabled
*/</span>
<span class="token keyword">void</span> <span class="token function">serial_configure_modem</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> com<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token comment">/* Bit:     | 7 | 6 | 5  | 4  | 3   | 2   | 1   | 0   |
	* Content:  | r | r | af | lb | ao2 | ao1 | rts | dtr |
	* Value:    | 0 | 0 | 0  | 0  |  0  |  0  |  1  |  1  | = 0x03
	*/</span>
	<span class="token function">outb</span><span class="token punctuation">(</span><span class="token function">SERIAL_MODEM_COMMAND_PORT</span><span class="token punctuation">(</span>com<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0x03</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token comment">/** serial_is_transmit_fifo_empty:
 *  Checks whether the transmit FIFO queue is empty or not for the given COM
 *  port.
 *
 *  @param  com The COM port
 *  @return 0 if the transmit FIFO queue is not empty
 *          1 if the transmit FIFO queue is empty
 */</span>
<span class="token keyword">int</span> <span class="token function">serial_is_transmit_fifo_empty</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> com<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">/* 0x20 = 0010 0000 */</span>
    <span class="token keyword">return</span> <span class="token function">inb</span><span class="token punctuation">(</span><span class="token function">SERIAL_LINE_STATUS_PORT</span><span class="token punctuation">(</span>com<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x20</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">serial_set_up</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token function">serial_configure_baud_rate</span><span class="token punctuation">(</span>SERIAL_COM1_BASE<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">serial_configure_line</span><span class="token punctuation">(</span>SERIAL_COM1_BASE<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">serial_configure_buffers</span><span class="token punctuation">(</span>SERIAL_COM1_BASE<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">serial_configure_modem</span><span class="token punctuation">(</span>SERIAL_COM1_BASE<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">serial_write</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span> buf<span class="token punctuation">,</span> <span class="token keyword">int</span> len<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token keyword">int</span> burst_length <span class="token operator">=</span> <span class="token punctuation">(</span>len <span class="token operator">&lt;</span> <span class="token number">14</span><span class="token punctuation">)</span> <span class="token operator">?</span> len <span class="token punctuation">:</span> <span class="token number">14</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

	<span class="token keyword">while</span> <span class="token punctuation">(</span>burst_length<span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
		<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">serial_is_transmit_fifo_empty</span><span class="token punctuation">(</span>SERIAL_COM1_BASE<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

		<span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> burst_length<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span>
		<span class="token punctuation">{</span>
			<span class="token function">outb</span><span class="token punctuation">(</span><span class="token function">SERIAL_DATA_PORT</span><span class="token punctuation">(</span>SERIAL_COM1_BASE<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">*</span><span class="token punctuation">(</span>buf <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		buf <span class="token operator">+</span><span class="token operator">=</span> burst_length<span class="token punctuation">;</span>
		len <span class="token operator">-</span><span class="token operator">=</span> burst_length<span class="token punctuation">;</span>

		burst_length <span class="token operator">=</span> <span class="token punctuation">(</span>len <span class="token operator">&lt;</span> <span class="token number">14</span><span class="token punctuation">)</span> <span class="token operator">?</span> len <span class="token punctuation">:</span> <span class="token number">14</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>We actually only need two of the functions above, write the header file <code>serialport.h</code> in <code>headers</code> folder:</p><div class="language-c extra-class"><pre class="language-c"><code><span class="token macro property">#<span class="token directive keyword">ifndef</span> INCLUDE_SERIAL_H</span>
<span class="token macro property">#<span class="token directive keyword">define</span> INCLUDE_SERIAL_H</span>
<span class="token keyword">void</span> <span class="token function">serial_set_up</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">serial_write</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span> buf<span class="token punctuation">,</span> <span class="token keyword">int</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>
</code></pre></div><p>Before we run the <code>make</code>, we need to change the configuration file of <code>Bochs</code> by adding:</p><div class="language- extra-class"><pre class="language-text"><code>...
com1: enabled=1, mode=file, dev=com1.out
</code></pre></div><p>This will save the output from the first serial port into a file called <code>com1.out</code>.</p><p>Then back to <code>kmain.c</code>:</p><div class="language-c extra-class"><pre class="language-c"><code><span class="token comment">/* IO */</span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&quot;serialport.h&quot;</span></span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">char</span> portMsg<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">&quot;port message!&quot;</span><span class="token punctuation">;</span>
    <span class="token function">serial_set_up</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">serial_write</span><span class="token punctuation">(</span>portMsg<span class="token punctuation">,</span> <span class="token number">14</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Finally run the <code>Bochs</code>, there will be a file called <code>com1.out</code> file generated in the <code>root</code> directory. Type command <code>cat com1.out</code> in the terminal, the string <code>port message!</code> where defined in the <code>kmain.c</code> will displayed on the terminal! üéâ</p><p><img src="/assets/img/4.3_serialportResult.0e9a1b6b.png" alt="4.3_serialportResult"></p></div><div class="content edit-link"><!----><!----></div><div class="content page-nav"><p class="inner"><span class="prev">
        ‚Üê <a href="/Section3.html" class="prev">
          Section 3 Notes
        </a></span><!----></p></div></div></div></div>
    <script src="/assets/js/1.88d0d0ab.js" defer></script><script src="/assets/js/app.120eb4dd.js" defer></script>
  </body>
</html>
